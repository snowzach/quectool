<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple Admin</title>
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    /> -->
    <!-- Import all the bootstrap css files from css folder -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!--  Import BootStrap Javascript -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/alpinejs.min.js" defer></script>
  </head>
  <body>
    <main>
      <div class="container my-4" x-data="getStaticNetworkInfo()">
        <nav class="navbar navbar-expand-lg mt-2">
          <div class="container-fluid">
            <a class="navbar-brand" href="/"
              ><span class="mb-0 h4">Simple Admin</span></a
            >
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarText"
              aria-controls="navbarText"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/"
                    >Home</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="network.html">Simple Network</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/settings.html">Simple Settings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/sms.html">SMS</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/deviceinfo.html"
                    >Device Information</a
                  >
                </li>
              </ul>
              <span class="navbar-text">
                <button class="btn btn-link text-reset" id="darkModeToggle">
                  Dark Mode
                </button>
              </span>
            </div>
          </div>
        </nav>

        <div class="row align-items-center mt-5 gap-md-3 gap-2">
          <div class="col align-self-center">
            <div class="card">
              <div
                class="card-body d-flex flex-column align-items-center justify-content-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 320 512"
                  height="85"
                  width="85"
                >
                  <path
                    fill="#fdb53c"
                    d="M160 64c-26.5 0-48 21.5-48 48V276.5c0 17.3-7.1 31.9-15.3 42.5C86.2 332.6 80 349.5 80 368c0 44.2 35.8 80 80 80s80-35.8 80-80c0-18.5-6.2-35.4-16.7-48.9c-8.2-10.6-15.3-25.2-15.3-42.5V112c0-26.5-21.5-48-48-48zM48 112C48 50.2 98.1 0 160 0s112 50.1 112 112V276.5c0 .1 .1 .3 .2 .6c.2 .6 .8 1.6 1.7 2.8c18.9 24.4 30.1 55 30.1 88.1c0 79.5-64.5 144-144 144S16 447.5 16 368c0-33.2 11.2-63.8 30.1-88.1c.9-1.2 1.5-2.2 1.7-2.8c.1-.3 .2-.5 .2-.6V112zM208 368c0 26.5-21.5 48-48 48s-48-21.5-48-48c0-20.9 13.4-38.7 32-45.3V272c0-8.8 7.2-16 16-16s16 7.2 16 16v50.7c18.6 6.6 32 24.4 32 45.3z"
                  />
                </svg>
                <h1
                  class="card-text mt-4"
                  x-text="temperature + ' &deg;C'"
                ></h1>
              </div>
              <div class="card-footer">Temperature</div>
            </div>
          </div>

          <div class="col align-self-center">
            <div class="card">
              <div
                class="card-body d-flex flex-column align-items-center justify-content-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 640 512"
                  height="85"
                  width="85"
                >
                  <path
                    fill="#2fa7fb"
                    d="M576 0c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V32c0-17.7 14.3-32 32-32zM448 96c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32zM352 224V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32zM192 288c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320c0-17.7 14.3-32 32-32zM96 416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V416c0-17.7 14.3-32 32-32s32 14.3 32 32z"
                  />
                </svg>
                <h1 class="card-text mt-4" x-text="signalPercentage + '%'"></h1>
              </div>
              <div class="card-footer">Signal %</div>
            </div>
          </div>

          <div class="col align-self-center">
            <div class="card">
              <div
                class="card-body d-flex flex-column align-items-center justify-content-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 640 512"
                  height="85"
                  width="85"
                >
                  <path
                    fill="#20c0ae"
                    d="M0 336c0 79.5 64.5 144 144 144H512c70.7 0 128-57.3 128-128c0-61.9-44-113.6-102.4-125.4c4.1-10.7 6.4-22.4 6.4-34.6c0-53-43-96-96-96c-19.7 0-38.1 6-53.3 16.2C367 64.2 315.3 32 256 32C167.6 32 96 103.6 96 192c0 2.7 .1 5.4 .2 8.1C40.2 219.8 0 273.2 0 336z"
                  />
                </svg>
                <h1 class="card-text mt-4" x-text="internetConnection"></h1>
              </div>
              <div class="card-footer">Internet Connection</div>
            </div>
          </div>
        </div>

        <div class="row mt-5 gap-3">
          <div class="col">
            <div class="card">
              <div class="card-header">Network Information</div>
              <div class="card-body">
                <div class="card-text table-responsive-sm">
                  <table class="table">
                    <tbody>
                      <tr>
                        <th scope="row">Active Sim</th>
                        <td x-text="active_sim"></td>
                      </tr>
                      <tr>
                        <th scope="row">Network Provider</th>
                        <td x-text="network_provider"></td>
                      </tr>
                      <tr>
                        <th scope="row">MCCMNC</th>
                        <td x-text="mccmnc"></td>
                      </tr>
                      <tr>
                        <th scope="row">APN</th>
                        <td x-text="apn"></td>
                      </tr>
                      <tr>
                        <th scope="row">Network Mode</th>
                        <td x-text="network_mode"></td>
                      </tr>
                      <tr>
                        <th scope="row">Bands</th>
                        <td x-text="bands"></td>
                      </tr>
                      <tr>
                        <th scope="row">Bandwidth</th>
                        <td x-text="bandwidth"></td>
                      </tr>
                      <tr>
                        <th scope="row">E/ARFCN<sup>4G/5G</sup></th>
                        <td x-text="earfcns"></td>
                      </tr>
                      <tr>
                        <th scope="row">PCI</th>
                        <td x-text="pcc_pci + ', ' + scc_pci"></td>
                      </tr>
                      <tr>
                        <th scope="row">IPv<sup>4</sup></th>
                        <td x-text="ipv4"></td>
                      </tr>
                      <tr>
                        <th scope="row">IPv<sup>6</sup></th>
                        <td x-text="ipv6"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer">
                <div class="row row-cols-2">
                  <div class="col">
                    <p class="btn">Refresh Rate (min 3s)</p>
                  </div>
                  <div class="col">
                    <div class="input-group">
                      <input
                        x-model="newRefreshRate"
                        class="form-control"
                        type="number"
                        min="3"
                        max="60"
                        x-bind:placeholder="refreshRate + 's'"
                      />
                      <button
                        @click="updateRefreshRate()"
                        class="btn btn-outline-secondary"
                        type="button"
                      >
                        Set
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card">
              <div class="card-header">Signal Information</div>
              <div class="card-body">
                <div class="card-text table-responsive-sm">
                  <table class="table">
                    <tbody>
                      <tr>
                        <th scope="row">Assesment</th>
                        <td x-text="signalAssessment"></td>
                      </tr>
                      <tr>
                        <th scope="row">CSQ</th>
                        <td x-text="csq"></td>
                      </tr>
                      <tr>
                        <th scope="row">CELL ID</th>
                        <td x-text="cellID"></td>
                      </tr>
                      <tr>
                        <th scope="row">eNB ID <sup>4G/5G</sup></th>
                        <td x-text="eNBID"></td>
                      </tr>
                      <tr>
                        <th scope="row">TAC<sup>4G/5G</sup></th>
                        <td x-text="tac"></td>
                      </tr>
                      <tr>
                        <th scope="row">RSSI</th>
                        <td x-text="rssi"></td>
                      </tr>
                      <tr>
                        <th scope="row">SS_RSRQ<sup>4G</sup></th>
                        <td
                          class="gap-4 align-items-center"
                          x-data="{ getProgressBarClass: function() {
                          // Remove the percentage sign and convert to integer
                          var percentage = parseInt(this.rsrqLTEPercentage);
                          
                          if (percentage >= 60) {
                              return 'progress-bar bg-success is-medium';
                          } else if (percentage >= 40) {
                              return 'progress-bar bg-warning is-warning is-medium';
                          } else {
                              return 'progress-bar bg-danger is-medium';
                          }
                      } }"
                        >
                          <div
                            x-show="rsrqLTE != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="RSRQ BAR"
                            :aria-valuenow="rsrqLTEPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + rsrqLTEPercentage + '%'"
                            >
                              <span
                                x-text="rsrqLTE + ' / ' +  rsrqLTEPercentage + '%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">SS_RSRQ<sup>5G</sup></th>
                        <td
                          x-data="{ getProgressBarClass: function() {
                          // Remove the percentage sign and convert to integer
                          var percentage = parseInt(this.rsrqNRPercentage);
                          
                          if (percentage >= 60) {
                              return 'progress-bar bg-success is-medium';
                          } else if (percentage >= 40) {
                              return 'progress-bar bg-warning is-warning is-medium';
                          } else {
                              return 'progress-bar bg-danger is-medium';
                          }
                      } }"
                        >
                          <div
                            x-show="rsrqNR != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="RSRQ BAR"
                            :aria-valuenow="rsrqNRPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + rsrqNRPercentage + '%'"
                            >
                              <span
                                x-text="rsrqNR + ' / ' + rsrqNRPercentage + '%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">RSRP<sup>4G</sup></th>
                        <td
                          class="gap-4 align-items-center"
                          x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.rsrpLTEPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }"
                        >
                          <div
                            x-show="rsrpLTE != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="RSRP BAR"
                            :aria-valuenow="rsrpLTEPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + rsrpLTEPercentage + '%'"
                            >
                              <span
                                x-text="rsrpLTE + ' / ' + rsrpLTEPercentage + '%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">SS_RSRP<sup>5G</sup></th>
                        <td
                          class="gap-4 align-items-center"
                          x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.rsrpNRPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }"
                        >
                          <div
                            x-show="rsrpNR != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="RSRP BAR"
                            :aria-valuenow="rsrpNRPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + rsrpNRPercentage + '%'"
                            >
                              <span
                                x-text="rsrpNR + ' / ' + rsrpNRPercentage + '%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">SINR<sup>4G</sup></th>
                        <td
                          class="gap-4 align-items-center"
                          x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.sinrLTEPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }"
                        >
                          <div
                            x-show="sinrLTE != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="SINR BAR"
                            :aria-valuenow="sinrLTEPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + sinrLTEPercentage +'%'"
                            >
                              <span
                                x-text="sinrLTE + ' / ' + sinrLTEPercentage +'%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">SINR<sup>5G</sup></th>
                        <td
                          class="gap-4 align-items-center"
                          x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.sinrNRPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }"
                        >
                          <div
                            x-show="sinrNR != '-'"
                            class="progress w-100"
                            role="progressbar"
                            aria-label="SINR BAR"
                            :aria-valuenow="sinrNRPercentage"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="height: 18px"
                          >
                            <div
                              :class="getProgressBarClass()"
                              :style="'width: ' + sinrNRPercentage +'%'"
                            >
                              <span
                                x-text="sinrNR + ' / ' + sinrNRPercentage +'%'"
                              ></span>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer">
                <div class="card-text">
                  <div class="row">
                    <div class="col">
                      <div>
                        <p>Date Updated</p>
                      </div>
                    </div>

                    <div class="col">
                      <p x-text="lastUpdate"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script src="/js/dark-mode.js"></script>
    <script>
      function getStaticNetworkInfo() {
        return {
          atcmd: null,
          temperature: "0",
          active_sim: "?",
          network_provider: "?",
          mccmnc: "?",
          apn: "?",
          network_mode: "?",
          ipv4: "?",
          ipv6: "?",
          bands: "?",
          bandwidth: "?",
          earfcns: "?",
          pcc_pci: "?",
          scc_pci: "-",
          signalAssessment: "Unknown",
          csq: "-",
          rssi: "-",
          cellID: "?",
          eNBID: "?",
          tac: "?",
          rsrqLTE: "-",
          rsrqNR: "-",
          rsrqLTEPercentage: "0%",
          rsrqNRPercentage: "0%",
          rsrpLTE: "-",
          rsrpNR: "-",
          rsrpLTEPercentage: "0%",
          rsrpNRPercentage: "0%",
          sinrLTE: "-",
          sinrNR: "-",
          sinrLTEPercentage: "0%",
          sinrNRPercentage: "0%",
          signalPercentage: "0",
          internetConnection: "Disconnected",
          lastUpdate: new Date().toLocaleString(),
          newRefreshRate: null,
          refreshRate: 30,
          intervalId: null,
          fetchNetworkInfo() {
            this.atcmd =
              'AT+QTEMP;+QUIMSLOT?;+QSPN;+CGCONTRDP=1;+QMAP="WWANIP";+QENG="servingcell";+QCAINFO';
            fetch(
              "/api/atcmd?" +
                new URLSearchParams({
                  atcmd: this.atcmd,
                })
            ).then((response) => {
              response.json().then((data) => {
                const temp1 = this.findRegexpValue(data.response, /^\+QTEMP:"modem-lte-sub6.*","(\d+)"/, 1, 0);
                const temp2 = this.findRegexpValue(data.response, /^\+QTEMP:"modem-ambient.*","(\d+)"/, 1, 0);
                // Average the 2 temperatures then add degree symbol
                this.temperature = (parseInt(temp1) + parseInt(temp2)) / 2;
                // Round the temperature to only show whole numbers
                this.temperature = Math.round(this.temperature).toString();

                // Parse the active sim
                this.active_sim = this.findRegexpValue(data.response, /^\+QUIMSLOT: (\d+)/);

                // Parse the network provider
                this.network_provider = this.findRegexpValue(data.response, /^\+QSPN: \"([^"]+)\"/);

                // Parse the APN
                this.apn = this.findRegexpValue(data.response, /^\+CGCONTRDP: [\d,]+\"([^"]+)\"/);
                
                // Parse the WAN IPs
                this.ipv4 = this.findRegexpValue(data.response, /^\+QMAP: \"WWAN\",1,1,\"IPV4\","([^"]+)\"/);
                this.ipv6 = this.findRegexpValue(data.response, /^\+QMAP: \"WWAN\",1,1,\"IPV6\","([^"]+)\"/);

                // Parse the network mode
                this.network_mode = this.findRegexpValue(data.response, /^\+QENG: \"[^"]+\",\"[^"]+\","([^"]+)\"/);
                this.mccmnc = this.findRegexpValue(data.response, /^\+QENG: \"[^"]+\",\"[^"]+\","[^"]+\",\"[^"]+\",(\d+,\d+),/).replace(',','');
      
                if (this.network_mode !== 'NR5G-SA') {
                  this.network_mode = "OTHER";
                  // let networkMode2, networkMode3;

                  // if (
                  //   lines[27] !== undefined &&
                  //   lines[27] !== "OK" &&
                  //   lines[27] !== "" &&
                  //   lines[27] !== "/r"
                  // ) {
                  //   // Check if lines[27] doesnt have TDD or FDD
                  //   if (lines[27].match(/FDD/) != null || lines[27].match(/TDD/) != null) {
                  //     networkMode2 = lines[27].split(",")[2].replace(/"/g, "");
                  //     networkMode2 = networkMode2.split(",")[0].trim();
                  //     console.log(networkMode2);
                  //   }

                  //   if (networkMode2 !== "LTE") {
                  //     networkMode2 = lines[28].split(":")[1].replace(/"/g, "");
                  //     networkMode2 = networkMode2.split(",")[0];

                  //     if (
                  //       lines[29] !== undefined &&
                  //       lines[29] !== "OK" &&
                  //       lines[29] !== ""
                  //     ) {
                  //       networkMode3 = lines[29]
                  //         .split(":")[1]
                  //         .split(",")[0]
                  //         .replace(/"/g, "");
                  //       networkMode3 = networkMode3.split(",")[0];
                  //     }
                  //   }
                  // }

                  // console.log(networkMode2, networkMode3);
                  // // Check if networkMode3 is not empty
                  // if (networkMode3 !== undefined) {
                  //   this.network_mode = networkMode2 + ", " + networkMode3;
                  // } else {
                  //   this.network_mode = networkMode2;
                  // }
                }

                // Parse the bands
                let bands = [];
                let earfcns = [];
                let earfcnValues;
                let bandValues;

                const bandRegex = /^\+QCAINFO: \"([^"]+)\",(\d+),(\d+),\"([^"]+)\",(\d+)/;
                for (i in data.response) {
                  const matches = bandRegex.exec(data.response[i]);
                  if(matches) {
                    earfcns.push(matches[2]);
                    bands.push(matches[4]);
                  }
                }

                // Convert bands to a single string separated by a comma
                this.bands = bands.join(", ");
                this.earfcns = earfcns.join(", ");

                // Parse the bandwidth
                if (this.network_mode === "NR5G-SA") {

                  let qeng = this.findRegexpValue(data.response, /^\+QENG: (.*)/);

                  let nr_bw = qeng.split(",")[11].replace(/"/g, "");
                  nr_bw = parseInt(nr_bw);

                  // Calculate the NR bandwidth
                  this.bandwidth = this.calculate_nr_bw(nr_bw).toString() + " MHz";

                  // Parse the PCIs
                  this.pcc_pci = qeng.split(",")[7].replace(/"/g, "");
                  //TODO: Add the scc_pci for NR-CA SA later

                  // Parse the Cell ID
                  const longCID = qeng.split(",")[6].replace(/"/g, "");

                  // Get the eNBID. Its just Cell ID minus the last 2 characters
                  this.eNBID = longCID.substring(0, longCID.length - 2);

                  // Get the short Cell ID (Last 2 characters of the Cell ID)
                  const shortCID = longCID.substring(longCID.length - 2);

                  // Get the TAC
                  this.tac = qeng.split(",")[8].replace(/"/g, "");

                  this.cellID =
                    "Short " +
                    shortCID +
                    "(" +
                    parseInt(shortCID, 16) +
                    ")" +
                    ", " +
                    "Long " +
                    longCID +
                    "(" +
                    parseInt(longCID, 16) +
                    ")";

                  // Get the RSRQ
                  this.rsrqNR = qeng.split(",")[13].replace(/"/g, "");
                  let rsrq = parseInt(this.rsrqNR);

                  // Calculate the RSRQ percentage
                  this.rsrqNRPercentage = this.calculateRSRQPercentage(rsrq);

                  // Get the RSRP
                  this.rsrpNR = qeng.split(",")[12].replace(/"/g, "");

                  // Calculate the RSRP percentage
                  this.rsrpNRPercentage = this.calculateRSRPPercentage(
                    parseInt(this.rsrpNR)
                  );

                  // Get the SINR
                  this.sinrNR = qeng.split(",")[14].replace(/"/g, "");

                  // Calculate the SINR percentage
                  this.sinrNRPercentage = this.calculateSINRPercentage(
                    parseInt(this.sinrNR)
                  );

                  // Calculate Signal Percentage
                  this.signalPercentage = this.calculateSignalPercentage(
                    parseInt(this.rsrpNRPercentage),
                    parseInt(this.sinrNRPercentage)
                  );

                  // Get the Signal Assessment
                  this.signalAssessment = this.signalQuality(
                    this.signalPercentage
                  );
                } else {
                  let lte_bw_ul = lines[28].split(",")[8].replace(/"/g, "");
                  let lte_bw_dl = lines[28].split(",")[9].replace(/"/g, "");

                  lte_bw_dl = parseInt(lte_bw_dl);
                  lte_bw_ul = parseInt(lte_bw_ul);

                  // Calculate the LTE bandwidth
                  this.bandwidth =
                    this.calculate_lte_bw(lte_bw_ul) +
                    " MHz / " +
                    this.calculate_lte_bw(lte_bw_dl) +
                    " MHz";

                  // Get the RSSI
                  this.rssi = lines[28].split(",")[13].replace(/"/g, "");

                  // Get the Cell ID
                  const longCID = lines[28].split(",")[4].replace(/"/g, "");

                  // Get the eNBID. Its just Cell ID minus the last 2 characters
                  this.eNBID = longCID.substring(0, longCID.length - 2);

                  // Get the short Cell ID (Last 2 characters of the Cell ID)
                  const shortCID = longCID.substring(longCID.length - 2);

                  // Get the TAC
                  this.tac = lines[28].split(",")[10].replace(/"/g, "");
                  this.tac = this.tac + " (" + parseInt(this.tac, 16) + ")";

                  this.cellID =
                    "Short " +
                    shortCID +
                    "(" +
                    parseInt(shortCID, 16) +
                    ")" +
                    ", " +
                    "Long " +
                    longCID +
                    "(" +
                    parseInt(longCID, 16) +
                    ")";

                  // Parse the PCIs
                  this.pcc_pci = lines[28].split(",")[5].replace(/"/g, "");

                  // Get the RSRQ
                  this.rsrqLTE = lines[28].split(",")[12].replace(/"/g, "");
                  let rsrq = parseInt(this.rsrqLTE);

                  // Calculate the RSRQ percentage
                  this.rsrqLTEPercentage = this.calculateRSRQPercentage(rsrq);

                  // Get the RSRP
                  this.rsrpLTE = lines[28].split(",")[11].replace(/"/g, "");

                  // Calculate the RSRP percentage
                  this.rsrpLTEPercentage = this.calculateRSRPPercentage(
                    parseInt(this.rsrpLTE)
                  );

                  // Get the SINR
                  this.sinrLTE = lines[28].split(",")[14].replace(/"/g, "");

                  // Calculate the SINR percentage
                  this.sinrLTEPercentage = this.calculateSINRPercentage(
                    parseInt(this.sinrLTE)
                  );

                  // Calculate Signal Percentage
                  this.signalPercentage = this.calculateSignalPercentage(
                    parseInt(this.rsrpLTEPercentage),
                    parseInt(this.sinrLTEPercentage)
                  );

                  // Get the Signal Assessment
                  this.signalAssessment = this.signalQuality(
                    this.signalPercentage
                  );

                  if (this.network_mode.match(/NR5G-NSA/) != null) {
                    let nr_bw = lines[29].split(",")[9].replace(/"/g, "");

                    nr_bw = parseInt(nr_bw);

                    // Calculate the NR bandwidth
                    this.bandwidth +=
                      " / " + this.calculate_nr_bw(nr_bw).toString() + " MHz";

                    // Parse the PCIs
                    this.pcc_pci = lines[28].split(",")[5].replace(/"/g, "");
                    this.scc_pci = lines[29].split(",")[3].replace(/"/g, "");

                    // Get the RSSI
                    this.rssi = lines[28].split(",")[13].replace(/"/g, "");

                    // Get the RSRQ NR
                    this.rsrqNR = lines[29].split(",")[6].replace(/"/g, "");
                    let rsrq = parseInt(this.rsrqNR);

                    // Calculate the RSRQ percentage
                    this.rsrqNRPercentage = this.calculateRSRQPercentage(rsrq);

                    // Get the RSRP NR
                    this.rsrpNR = lines[29].split(",")[4].replace(/"/g, "");

                    // Calculate the RSRP percentage
                    this.rsrpNRPercentage = this.calculateRSRPPercentage(
                      parseInt(this.rsrpNR)
                    );

                    // Get the SINR NR
                    this.sinrNR = lines[29].split(",")[5].replace(/"/g, "");

                    // Calculate the SINR percentage
                    this.sinrNRPercentage = this.calculateSINRPercentage(
                      parseInt(this.sinrNR)
                    );

                    // Calculate Signal Percentage
                    const nrSignalPercentage = this.calculateSignalPercentage(
                      parseInt(this.rsrpNRPercentage),
                      parseInt(this.sinrNRPercentage)
                    );

                    // Get the average of the LTE and NR Signal Percentage
                    this.signalPercentage =
                      (this.signalPercentage + nrSignalPercentage) / 2;

                    // Round the signalPercentage value
                    this.signalPercentage = Math.round(this.signalPercentage);

                    // Get the Signal Assessment
                    this.signalAssessment = this.signalQuality(
                      this.signalPercentage
                    );
                  }
                }
              });
            });
          },

          calculate_lte_bw(lte_bw) {
            switch (true) {
              case 0:
                return 1.4;
              case 1:
                return 3;
              // Now case 2 - 5
              case lte_bw >= 2 && lte_bw <= 5:
                return (lte_bw - 1) * 5;
              default:
                return "-";
            }
          },

          calculate_nr_bw(nr_bw) {
            switch (true) {
              case nr_bw >= 0 && nr_bw <= 5:
                return (nr_bw + 1) * 5;
              case nr_bw >= 6 && nr_bw <= 12:
                return (nr_bw - 2) * 10;
              case nr_bw === 13:
                return "200";
              case nr_bw === 14:
                return "400";
              default:
                return "-";
            }
          },

          calculateRSRQPercentage(rsrq) {
            let RSRQ_min = -20;
            let RSRQ_max = -8;

            // If rsrq is null, return 0%
            if (isNaN(rsrq)) {
              return 0;
            }

            let percentage = ((rsrq - RSRQ_min) / (RSRQ_max - RSRQ_min)) * 100;

            if (percentage > 100) {
              percentage = 100;
            }

            return Math.round(percentage);
          },

          calculateRSRPPercentage(rsrp) {
            let RSRP_min = -140;
            let RSRP_max = -60;

            // If rsrp is null, return 0%
            if (isNaN(rsrp)) {
              return 0;
            }

            let percentage = ((rsrp - RSRP_min) / (RSRP_max - RSRP_min)) * 100;

            if (percentage > 100) {
              percentage = 100;
            }

            return Math.round(percentage);
          },

          calculateSINRPercentage(sinr) {
            let SINR_min = 0;
            let SINR_max = 35;

            // If sinr is null, return 0%
            if (isNaN(sinr)) {
              return 0;
            }

            let percentage = ((sinr - SINR_min) / (SINR_max - SINR_min)) * 100;

            if (percentage > 100) {
              percentage = 100;
            }

            return Math.round(percentage);
          },

          // Calculate the overall signal assessment
          calculateSignalPercentage(rsrpNRPercentage, sinrNRPercentage) {
            // Get the average of the RSRP Percentage and SINR Percentage
            let average = (rsrpNRPercentage + sinrNRPercentage) / 2;
            return Math.round(average);
          },

          signalQuality(percentage) {
            if (percentage >= 80) {
              return "Excellent";
            } else if (percentage >= 60) {
              return "Good";
            } else if (percentage >= 40) {
              return "Fair";
            } else if (percentage >= 0) {
              return "Poor";
            } else {
              return "No Signal";
            }
          },

          fetchCSQ() {
            if (this.network_mode !== "NR5G-SA") {
              this.atcmd = "AT+CSQ";
              fetch(
                "/api/atcmd?" +
                  new URLSearchParams({
                    atcmd: this.atcmd,
                  })
              ).then((response) => {
                response.json().then((data) => {
                  console.log("CSQ: ", data.response);

                  this.csq = data.response[1].split(":")[1].split(",")[0].trim();
                });
              });
            }
          },

          findRegexpValue(array, regexp, index = 1, notFound = "?") {
            for (i in array) {
              const matches = regexp.exec(array[i]);
              if(matches) return matches[index];
            }
            return notFound;
          },

          requestPing() {
            return fetch("/cgi-bin/get_ping")
              .then((response) => response.text())
              .then((data) => {
                return data;
              })
              .catch((error) => {
                console.error("Error:", error);
                // Throw the error again to ensure it's propagated
                throw error;
              });
          },

          updateRefreshRate() {
            // Check if the refresh rate is less than 3
            if (this.newRefreshRate < 3) {
              this.newRefreshRate = 3;
            }

            // Clear the old interval
            clearInterval(this.intervalId);

            // Set the refresh rate
            this.refreshRate = this.newRefreshRate;
            console.log("Refresh Rate Updated to " + this.refreshRate);

            // Store the refresh rate in local storage or session storage
            localStorage.setItem("refreshRate", this.refreshRate);

            // Initialize with the new refresh rate
            this.init();
          },

          init() {
            // Retrieve the refresh rate from local storage or session storage
            const storedRefreshRate = localStorage.getItem("refreshRate");

            // If a refresh rate is stored, use it; otherwise, use a default value
            this.refreshRate = storedRefreshRate
              ? parseInt(storedRefreshRate)
              : 5; // Change 5 to your desired default value

            this.fetchNetworkInfo();
            // sleep for 2 seconds
            setTimeout(() => {
              this.fetchCSQ();
            }, 2000);

            this.requestPing()
              .then((data) => {
                const response = data.trim();
                // Trim any leading/trailing spaces
                if (response === "OK") {
                  this.internetConnection = "Connected";
                } else {
                  this.internetConnection = "Disconnected";
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                this.internetConnection = "Disconnected";
              });

            this.lastUpdate = new Date().toLocaleString();
            console.log("Initialized");

            // Set the refresh rate
            this.intervalId = setInterval(() => {
              this.fetchNetworkInfo();
              // sleep for 2 seconds
              setTimeout(() => {
                this.fetchCSQ();
              }, 2000);

              this.requestPing()
                .then((data) => {
                  const response = data.trim();
                  // Trim any leading/trailing spaces
                  if (response === "OK") {
                    this.internetConnection = "Connected";
                  } else {
                    this.internetConnection = "Disconnected";
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  this.internetConnection = "Disconnected";
                });

              this.lastUpdate = new Date().toLocaleString();
              console.log("Refreshed");
            }, this.refreshRate * 1000);
          },
        };
      }
    </script>
  </body>
</html>
